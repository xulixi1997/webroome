<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P ç»ˆæç‰ˆ - 1GB å¤§æ–‡ä»¶ä¼ è¾“</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #121212; color: #e0e0e0; }
        
        /* ç™»å½•é¡µ */
        #login-screen { text-align: center; margin-top: 100px; }
        input[type="text"] { padding: 12px; border: 1px solid #444; background: #2c2c2c; color: #fff; width: 220px; outline: none; border-radius: 4px; }
        .btn { padding: 12px 24px; background: #007acc; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn:disabled { background: #444; cursor: not-allowed; }
        
        /* èŠå¤©é¡µ */
        #chat-screen { display: none; height: 90vh; flex-direction: column; }
        #header { padding: 12px; background: #1f1f1f; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; border-radius: 8px 8px 0 0; }
        .status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #dc2626; margin-right: 5px; }
        .status-online { background: #16a34a; box-shadow: 0 0 5px #16a34a; }
        .status-reconnecting { background: #ca8a04; animation: blink 1s infinite; }
        
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; background: #1a1a1a; border: 1px solid #333; margin: 0; }
        
        /* æ¶ˆæ¯æ°”æ³¡ */
        .message-row { margin-bottom: 12px; display: flex; flex-direction: column; }
        .message-row.me { align-items: flex-end; }
        .message-row.other { align-items: flex-start; }
        .bubble { max-width: 75%; padding: 10px 14px; border-radius: 12px; font-size: 15px; word-wrap: break-word; position: relative; }
        .me .bubble { background: #007acc; color: white; border-bottom-right-radius: 2px; }
        .other .bubble { background: #333; color: #ddd; border-bottom-left-radius: 2px; }
        .sender-name { font-size: 11px; color: #666; margin-bottom: 2px; margin-left: 5px; }
        .me .sender-name { display: none; }
        
        /* æ–‡ä»¶è¿›åº¦æ¡æ ·å¼ */
        .file-progress-box { margin-top: 5px; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 4px; width: 200px; }
        .progress-bar { height: 6px; background: #444; border-radius: 3px; overflow: hidden; margin-top: 4px; }
        .progress-fill { height: 100%; background: #4ade80; width: 0%; transition: width 0.2s; }
        .file-info { font-size: 12px; display: flex; justify-content: space-between; }

        /* åº•éƒ¨è¾“å…¥åŒº */
        #input-area { display: flex; gap: 10px; padding: 10px; background: #1f1f1f; border-radius: 0 0 8px 8px; border: 1px solid #333; border-top: none; }
        #msg-input { flex: 1; padding: 10px; border-radius: 4px; border: 1px solid #444; background: #2c2c2c; color: white; }
        
        .file-btn-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .file-btn-wrapper input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        .icon-btn { padding: 10px 15px; background: #333; color: #ccc; border-radius: 4px; border: 1px solid #444; }
        
        @keyframes blink { 50% { opacity: 0.5; } }
        .system-msg { text-align: center; color: #666; font-size: 12px; margin: 8px 0; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2>ğŸš€ P2P å¤§æ–‡ä»¶ä¼ è¾“ç»ˆç«¯</h2>
        <p style="color: #666; font-size: 13px; margin-bottom: 20px;">æ”¯æŒ 1GB æ–‡ä»¶åˆ†ç‰‡ä¼ è¾“ Â· æ–­çº¿é‡è¿</p>
        <div>
            <input type="text" id="room-id-input" placeholder="è¾“å…¥æˆ¿é—´å· (ä¾‹: 999)" onkeypress="if(event.key==='Enter') startApp()">
            <button onclick="startApp()" id="btn-join" class="btn">è¿›å…¥æˆ¿é—´</button>
        </div>
        <p id="login-log" style="color: #eab308; font-size: 12px; margin-top: 15px;"></p>
    </div>

    <div id="chat-screen">
        <div id="header">
            <div>
                <span id="status-indicator" class="status-dot"></span>
                <span style="font-weight: bold;">æˆ¿é—´: <span id="room-tag">...</span></span>
            </div>
            <span id="role-tag" style="font-size: 12px; background: #333; padding: 2px 6px; border-radius: 4px;">...</span>
        </div>
        
        <div id="chat-box"></div>
        
        <div id="input-area">
            <div class="file-btn-wrapper">
                <button class="icon-btn">ğŸ“</button>
                <input type="file" id="file-input" onchange="handleFileSelect(this)">
            </div>
            <input type="text" id="msg-input" placeholder="è¾“å…¥æ¶ˆæ¯..." autocomplete="off" onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()" class="btn" style="padding: 10px 20px;">å‘é€</button>
        </div>
    </div>

    <script>
        // --- å…¨å±€é…ç½® ---
        const CHUNK_SIZE = 16 * 1024; // 16KB åˆ‡ç‰‡ï¼Œè™½ç„¶å°ä½†ä¼ è¾“æœ€ç¨³å®š
        const MAX_FILE_SIZE = 1024 * 1024 * 1024; // 1GB é™åˆ¶

        // --- çŠ¶æ€å˜é‡ ---
        let peer = null;
        let myRole = null; 
        let connMap = new Map(); // æˆ¿ä¸»å­˜æ‰€æœ‰è¿æ¥
        let hostConn = null;     // è®¿å®¢å­˜æˆ¿ä¸»è¿æ¥
        let roomId = '';
        let reconnectTimer = null;
        let isReconnecting = false;

        // --- æ–‡ä»¶ä¼ è¾“çŠ¶æ€ (ç”¨äºæ¥æ”¶æ‹¼è£…) ---
        // ç»“æ„: { fileId: { buffer: [], receivedSize: 0, totalSize: 0, fileName: '', ... } }
        let incomingFiles = {}; 

        function startApp() {
            roomId = document.getElementById('room-id-input').value.trim();
            if (!roomId) return showLoginLog("è¯·è¾“å…¥æˆ¿é—´å·");
            
            document.getElementById('btn-join').disabled = true;
            document.getElementById('btn-join').innerText = "è¿æ¥ä¸­...";
            
            const safeRoomId = 'p2p-file-room-' + roomId;
            const tempPeer = new Peer(safeRoomId);

            tempPeer.on('open', (id) => {
                peer = tempPeer;
                initHostMode();
            });

            tempPeer.on('error', (err) => {
                if (err.type === 'unavailable-id') {
                    tempPeer.destroy();
                    initGuestMode(safeRoomId);
                } else {
                    showLoginLog("é”™è¯¯: " + err.type);
                    document.getElementById('btn-join').disabled = false;
                }
            });
        }

        // --- æ ¸å¿ƒæ¨¡å¼ ---
        function initHostMode() {
            myRole = 'host';
            setupUI(roomId, 'æˆ¿ä¸» (Host)');
            updateStatus('online');
            addSystemMsg("æˆ¿é—´åˆ›å»ºæˆåŠŸ");

            peer.on('connection', (conn) => {
                setupConnection(conn);
            });
            peer.on('disconnected', () => { updateStatus('reconnecting'); peer.reconnect(); });
            peer.on('open', () => updateStatus('online'));
        }

        function initGuestMode(hostId) {
            myRole = 'guest';
            peer = new Peer(); 

            peer.on('open', () => {
                setupUI(roomId, 'è®¿å®¢ (Guest)');
                connectToHost(hostId);
            });
            peer.on('disconnected', () => { updateStatus('reconnecting'); peer.reconnect(); });
        }

        function connectToHost(hostId) {
            updateStatus('reconnecting');
            const conn = peer.connect(hostId, { reliable: true });
            hostConn = conn;
            setupConnection(conn);

            setTimeout(() => {
                if (!conn.open && !isReconnecting) handleDisconnect(hostId);
            }, 5000);
        }

        // --- è¿æ¥å¤„ç† ---
        function setupConnection(conn) {
            conn.on('open', () => {
                isReconnecting = false;
                clearTimeout(reconnectTimer);
                updateStatus('online');
                if (myRole === 'host') connMap.set(conn.peer, conn);
            });

            conn.on('data', (data) => {
                handleData(data, conn);
            });

            conn.on('close', () => {
                if (myRole === 'host') connMap.delete(conn.peer);
                else {
                    handleDisconnect('p2p-file-room-' + roomId);
                }
            });
        }

        function handleDisconnect(hostId) {
            if (myRole !== 'guest') return;
            isReconnecting = true;
            updateStatus('reconnecting');
            if (reconnectTimer) clearTimeout(reconnectTimer);
            reconnectTimer = setTimeout(() => connectToHost(hostId), 3000);
        }

        // --- æ ¸å¿ƒæ•°æ®å¤„ç† (è·¯ç”± + åˆ†ç‰‡é‡ç»„) ---
        function handleData(data, senderConn) {
            // 1. æ™®é€šæ–‡æœ¬æ¶ˆæ¯
            if (data.type === 'msg') {
                renderMessage(data.content, false, data.senderName);
                if (myRole === 'host') broadcast(data, senderConn);
            }
            
            // 2. æ–‡ä»¶å…ƒæ•°æ® (å¼€å§‹ä¼ è¾“)
            else if (data.type === 'file-start') {
                // åˆå§‹åŒ–æ¥æ”¶å®¹å™¨
                incomingFiles[data.fileId] = {
                    buffer: [],
                    receivedSize: 0,
                    totalSize: data.totalSize,
                    fileName: data.fileName,
                    fileType: data.fileType,
                    senderName: data.senderName
                };
                // åˆ›å»ºè¿›åº¦æ¡ UI
                renderFileProgress(data.fileId, data.fileName, false, data.senderName);
                
                if (myRole === 'host') broadcast(data, senderConn);
            }

            // 3. æ–‡ä»¶åˆ†ç‰‡æ•°æ®
            else if (data.type === 'file-chunk') {
                const fileCtx = incomingFiles[data.fileId];
                if (fileCtx) {
                    // å­˜å…¥ Buffer
                    fileCtx.buffer.push(data.chunk);
                    fileCtx.receivedSize += data.chunk.byteLength;
                    
                    // æ›´æ–°è¿›åº¦æ¡
                    updateProgressBar(data.fileId, fileCtx.receivedSize, fileCtx.totalSize);

                    // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                    if (fileCtx.receivedSize >= fileCtx.totalSize) {
                        const blob = new Blob(fileCtx.buffer, { type: fileCtx.fileType });
                        finishFileDownload(data.fileId, blob, fileCtx.fileName);
                        delete incomingFiles[data.fileId]; // æ¸…ç†å†…å­˜
                    }
                }
                
                if (myRole === 'host') broadcast(data, senderConn);
            }
        }

        function broadcast(data, excludeConn = null) {
            connMap.forEach(conn => {
                if (conn !== excludeConn && conn.open) conn.send(data);
            });
        }

        // --- å‘é€é€»è¾‘ (åˆ†ç‰‡) ---
        function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text) return;
            
            const payload = { type: 'msg', content: text, senderName: myRole === 'host' ? 'æˆ¿ä¸»' : 'è®¿å®¢' };
            renderMessage(text, true);
            sendData(payload);
            input.value = '';
        }

        function sendData(payload) {
            if (myRole === 'host') broadcast(payload);
            else if (hostConn && hostConn.open) hostConn.send(payload);
        }

        // --- æ ¸å¿ƒï¼šæ–‡ä»¶åˆ‡ç‰‡å‘é€é€»è¾‘ ---
        async function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;

            if (file.size > MAX_FILE_SIZE) {
                alert("æ–‡ä»¶å¤ªå¤§ï¼ç›®å‰é™åˆ¶ 1GBã€‚");
                return;
            }

            const fileId = Date.now().toString() + Math.random().toString().substr(2, 5);
            const senderName = myRole === 'host' ? 'æˆ¿ä¸»' : 'è®¿å®¢';

            // 1. å‘é€å…ƒæ•°æ® (å‘Šè¯‰å¯¹æ–¹å‡†å¤‡æ¥æ”¶)
            const metaData = {
                type: 'file-start',
                fileId: fileId,
                fileName: file.name,
                fileType: file.type,
                totalSize: file.size,
                senderName: senderName
            };
            
            // æœ¬åœ°æ˜¾ç¤ºè¿›åº¦æ¡
            renderFileProgress(fileId, file.name, true);
            sendData(metaData);

            // 2. å¼€å§‹åˆ‡ç‰‡å‘é€
            let offset = 0;
            const reader = new FileReader();

            // å®šä¹‰è¯»å–å›è°ƒ
            reader.onload = function(e) {
                if (e.target.readyState !== FileReader.DONE) return;
                
                const chunk = e.target.result; // ArrayBuffer
                
                // å‘é€åˆ†ç‰‡
                sendData({
                    type: 'file-chunk',
                    fileId: fileId,
                    chunk: chunk
                });

                offset += chunk.byteLength;
                
                // æ›´æ–°æœ¬åœ°è¿›åº¦æ¡
                updateProgressBar(fileId, offset, file.size);

                // ç»§ç»­è¯»ä¸‹ä¸€ç‰‡
                if (offset < file.size) {
                    readNextChunk();
                } else {
                    console.log("æ–‡ä»¶å‘é€å®Œæ¯•");
                }
            };

            function readNextChunk() {
                const slice = file.slice(offset, offset + CHUNK_SIZE);
                reader.readAsArrayBuffer(slice);
            }

            // å¯åŠ¨è¯»å–
            readNextChunk();
            input.value = ''; 
        }

        // --- UI æ¸²æŸ“ ---
        function renderMessage(text, isMe, name) {
            const box = document.getElementById('chat-box');
            const row = document.createElement('div');
            row.className = `message-row ${isMe ? 'me' : 'other'}`;
            let html = (!isMe && name) ? `<div class="sender-name">${name}</div>` : '';
            html += `<div class="bubble">${escapeHtml(text)}</div>`;
            row.innerHTML = html;
            box.appendChild(row);
            scrollToBottom();
        }

        // æ¸²æŸ“è¿›åº¦æ¡æ¡†
        function renderFileProgress(fileId, fileName, isMe, senderName) {
            const box = document.getElementById('chat-box');
            const row = document.createElement('div');
            row.className = `message-row ${isMe ? 'me' : 'other'}`;
            
            let html = (!isMe && senderName) ? `<div class="sender-name">${senderName}</div>` : '';
            html += `
                <div class="bubble" id="bubble-${fileId}">
                    <div style="font-weight:bold; margin-bottom:5px;">${isMe ? 'æ­£åœ¨å‘é€' : 'æ­£åœ¨æ¥æ”¶'}: ${fileName}</div>
                    <div class="file-progress-box">
                        <div class="file-info">
                            <span>0%</span>
                            <span>...</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="prog-${fileId}"></div>
                        </div>
                    </div>
                </div>
            `;
            row.innerHTML = html;
            box.appendChild(row);
            scrollToBottom();
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgressBar(fileId, current, total) {
            const fill = document.getElementById(`prog-${fileId}`);
            const bubble = document.getElementById(`bubble-${fileId}`);
            if (!fill || !bubble) return;

            const percent = Math.floor((current / total) * 100);
            fill.style.width = `${percent}%`;
            
            // æ›´æ–°æ–‡å­—
            const infoSpan = bubble.querySelector('.file-info span');
            if (infoSpan) infoSpan.innerText = `${percent}%`;
        }

        // ä¼ è¾“å®Œæˆï¼Œå°†è¿›åº¦æ¡æ›¿æ¢ä¸ºä¸‹è½½é“¾æ¥
        function finishFileDownload(fileId, blob, fileName) {
            const bubble = document.getElementById(`bubble-${fileId}`);
            if (!bubble) return;
            
            const url = URL.createObjectURL(blob);
            const isImage = blob.type.startsWith('image/');

            let content = '';
            if (isImage) {
                content = `<img src="${url}" style="max-width:100%; border-radius:8px; cursor:pointer;" onclick="window.open('${url}')"><br><a href="${url}" download="${fileName}" style="color:#fff; font-size:12px;">ä¸‹è½½åŸå›¾</a>`;
            } else {
                content = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="font-size:24px">ğŸ’¾</span>
                        <div>
                            <div>${fileName}</div>
                            <a href="${url}" download="${fileName}" style="color:#fff; text-decoration:underline;">ç‚¹å‡»ä¸‹è½½</a>
                        </div>
                    </div>
                `;
            }
            bubble.innerHTML = content;
        }

        // --- è¾…åŠ©åŠŸèƒ½ ---
        function setupUI(room, role) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('chat-screen').style.display = 'flex';
            document.getElementById('room-tag').innerText = room;
            document.getElementById('role-tag').innerText = role;
        }
        function updateStatus(state) {
            const dot = document.getElementById('status-indicator');
            dot.className = 'status-dot'; 
            if (state === 'online') dot.classList.add('status-online');
            if (state === 'reconnecting') dot.classList.add('status-reconnecting');
        }
        function showLoginLog(msg) { document.getElementById('login-log').innerText = msg; }
        function addSystemMsg(msg) { document.getElementById('chat-box').innerHTML += `<div class="system-msg">${msg}</div>`; scrollToBottom(); }
        function scrollToBottom() { const box = document.getElementById('chat-box'); box.scrollTop = box.scrollHeight; }
        function escapeHtml(text) { return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
    </script>
</body>
</html>
