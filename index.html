<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P æç®€èŠå¤©å®¤</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #1a1a1a; color: #e0e0e0; }
        /* ç™»å½•é¡µæ ·å¼ */
        #login-screen { text-align: center; margin-top: 100px; }
        input { padding: 12px; font-size: 16px; border-radius: 4px; border: 1px solid #444; background: #333; color: #fff; width: 200px; outline: none; }
        button { padding: 12px 24px; font-size: 16px; background: #007acc; color: white; border: none; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        button:hover { background: #0062a3; }
        
        /* èŠå¤©é¡µæ ·å¼ */
        #chat-screen { display: none; height: 90vh; display: flex; flex-direction: column; } /* é»˜è®¤éšè—ï¼Œç”¨ js æ§åˆ¶æ˜¾ç¤º */
        #header { padding: 10px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        #room-tag { font-weight: bold; color: #007acc; }
        #role-tag { font-size: 12px; padding: 2px 6px; border-radius: 4px; }
        .role-host { background: #b91c1c; color: white; } /* çº¢è‰²æˆ¿ä¸» */
        .role-guest { background: #15803d; color: white; } /* ç»¿è‰²è®¿å®¢ */
        
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; background: #222; border: 1px solid #333; border-radius: 8px; margin: 10px 0; }
        .message-row { margin-bottom: 10px; display: flex; }
        .message-row.me { justify-content: flex-end; }
        .bubble { max-width: 70%; padding: 8px 12px; border-radius: 12px; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .me .bubble { background: #007acc; color: white; border-bottom-right-radius: 2px; }
        .other .bubble { background: #333; color: #ddd; border-bottom-left-radius: 2px; }
        .system-msg { text-align: center; color: #666; font-size: 13px; margin: 10px 0; }
        
        #input-area { display: flex; gap: 10px; }
        #msg-input { flex: 1; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2 style="color: #fff;">ğŸšª è¿›å…¥ç§˜å¯†èŠå¤©å®¤</h2>
        <p style="color: #888; font-size: 14px; margin-bottom: 20px;">æ•°æ®ä¸ç»æœåŠ¡å™¨å­˜å‚¨ Â· é¡µé¢å…³é—­å³ç„š</p>
        <div>
            <input type="text" id="room-id-input" placeholder="è¾“å…¥æˆ¿é—´æš—å· (å¦‚: 1234)" onkeypress="if(event.key==='Enter') startApp()">
            <button onclick="startApp()" id="btn-join">è¿›å…¥</button>
        </div>
        <p id="status-log" style="color: #eab308; font-size: 12px; margin-top: 15px; min-height: 20px;"></p>
    </div>

    <div id="chat-screen" style="display: none;"> <div id="header">
            <span>æˆ¿é—´: <span id="room-tag">...</span></span>
            <span id="role-tag" class="role-guest">æ­£åœ¨è¿æ¥...</span>
        </div>
        
        <div id="chat-box"></div>
        
        <div id="input-area">
            <input type="text" id="msg-input" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." autocomplete="off" onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()">å‘é€</button>
        </div>
    </div>

    <script>
        let peer = null;       // æˆ‘çš„ Peer å¯¹è±¡
        let myRole = 'unknown'; // 'host' æˆ– 'guest'
        let connections = [];   // å­˜æ”¾æ‰€æœ‰è¿æ¥å¯¹è±¡ (æˆ¿ä¸»ç”¨)
        let hostConnection = null; // å­˜æ”¾æˆ¿ä¸»è¿æ¥å¯¹è±¡ (è®¿å®¢ç”¨)
        let roomId = '';

        // å¯åŠ¨é€»è¾‘
        function startApp() {
            roomId = document.getElementById('room-id-input').value.trim();
            if (!roomId) return showLog("è¯·è¾“å…¥æˆ¿é—´å·");
            
            // é”å®šæŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            document.getElementById('btn-join').disabled = true;
            document.getElementById('btn-join').innerText = "æ­£åœ¨å°è¯•è¿›å…¥...";
            showLog("æ­£åœ¨æ¢æµ‹æˆ¿é—´çŠ¶æ€...");

            // 1. å°è¯•æ³¨å†Œä¸ºæˆ¿ä¸» (ä½¿ç”¨æˆ¿é—´å·ä½œä¸º Peer ID)
            // æ³¨æ„ï¼šPeerJS çš„ ID åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸­åˆ’çº¿
            const safeRoomId = 'room-' + roomId; 
            
            // å°è¯•ä»¥æˆ¿é—´ååˆå§‹åŒ– Peer
            const tempPeer = new Peer(safeRoomId);

            // æ³¨å†ŒæˆåŠŸ -> æˆ‘æ˜¯æˆ¿ä¸»
            tempPeer.on('open', (id) => {
                peer = tempPeer;
                initHostMode(id);
            });

            // æ³¨å†Œå¤±è´¥ (ID è¢«å ç”¨) -> æˆ¿é—´å·²å­˜åœ¨ -> æˆ‘æ˜¯è®¿å®¢
            tempPeer.on('error', (err) => {
                if (err.type === 'unavailable-id') {
                    showLog("æˆ¿é—´å·²å­˜åœ¨ï¼Œæ­£åœ¨ä½œä¸ºè®¿å®¢åŠ å…¥...");
                    // é”€æ¯æ—§å¯¹è±¡ï¼Œé‡æ–°åˆ›å»ºä¸€ä¸ªéšæœº ID çš„ Peer
                    tempPeer.destroy(); 
                    initGuestMode(safeRoomId);
                } else {
                    showLog("é”™è¯¯: " + err.type);
                    document.getElementById('btn-join').disabled = false;
                }
            });
        }

        // --- æˆ¿ä¸»æ¨¡å¼é€»è¾‘ ---
        function initHostMode(id) {
            myRole = 'host';
            enterChatScreen(roomId, 'æˆ¿ä¸» (Host)');
            addSystemMsg("ä½ åˆ›å»ºäº†æˆ¿é—´ã€‚ç­‰å¾…å…¶ä»–äººåŠ å…¥...");

            // ç›‘å¬åˆ«äººè¿æ¥æˆ‘
            peer.on('connection', (conn) => {
                connections.push(conn);
                setupConnection(conn);
                addSystemMsg("æ–°ç”¨æˆ·åŠ å…¥äº†èŠå¤©");
                
                // (å¯é€‰) å‘é€æ¬¢è¿è¯­
                conn.on('open', () => {
                    conn.send({ type: 'msg', content: 'æ¬¢è¿åŠ å…¥ï¼å½“å‰æˆ¿é—´ç”±ä½ ä¸»æŒã€‚', sender: 'System' });
                });
            });
        }

        // --- è®¿å®¢æ¨¡å¼é€»è¾‘ ---
        function initGuestMode(hostId) {
            // åˆ›å»ºä¸€ä¸ªéšæœº ID
            peer = new Peer(); 
            
            peer.on('open', () => {
                myRole = 'guest';
                enterChatScreen(roomId, 'è®¿å®¢ (Guest)');
                addSystemMsg("æ­£åœ¨è¿æ¥æˆ¿ä¸»...");
                
                // ä¸»åŠ¨è¿æ¥æˆ¿ä¸»
                const conn = peer.connect(hostId);
                hostConnection = conn;
                setupConnection(conn);
            });

            peer.on('error', err => {
                console.error(err);
                addSystemMsg("è¿æ¥æˆ¿ä¸»å¤±è´¥ï¼Œå¯èƒ½æˆ¿é—´åˆšå…³é—­ã€‚");
            });
        }

        // --- é€šç”¨è¿æ¥å¤„ç† (å¤„ç†æ”¶å‘æ¶ˆæ¯) ---
        function setupConnection(conn) {
            conn.on('open', () => {
                // è¿æ¥å»ºç«‹
            });

            conn.on('data', (data) => {
                // æ”¶åˆ°æ¶ˆæ¯ data = { type: 'msg', content: '...', sender: '...' }
                if (data.type === 'msg') {
                    // æ˜¾ç¤ºæ¶ˆæ¯
                    if (data.sender !== 'System') {
                        addMessageBubble(data.content, false);
                    } else {
                        addSystemMsg(data.content);
                    }

                    // å¦‚æœæˆ‘æ˜¯æˆ¿ä¸»ï¼Œæˆ‘è¦æŠŠè¿™æ¡æ¶ˆæ¯â€œå¹¿æ’­â€ç»™å…¶ä»–æ‰€æœ‰äºº
                    if (myRole === 'host') {
                        broadcastMessage(data, conn); // æ’é™¤æ¥æº connï¼Œä¸å†å‘å›ç»™å‘ä¿¡äºº
                    }
                }
            });

            conn.on('close', () => {
                addSystemMsg("æœ‰äººç¦»å¼€äº†èŠå¤©");
                // å¦‚æœæˆ‘æ˜¯æˆ¿ä¸»ï¼Œæ¸…ç†æ–­å¼€çš„è¿æ¥
                if (myRole === 'host') {
                    connections = connections.filter(c => c !== conn);
                }
            });
        }

        // --- å‘é€æ¶ˆæ¯é€»è¾‘ ---
        function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text) return;

            // 1. æ˜¾ç¤ºåœ¨è‡ªå·±å±å¹•ä¸Š
            addMessageBubble(text, true);

            // 2. åŒ…è£…æ¶ˆæ¯åŒ…
            const msgPackage = { type: 'msg', content: text, sender: peer.id };

            // 3. å‘é€
            if (myRole === 'host') {
                // æˆ¿ä¸»ï¼šå‘ç»™æ‰€æœ‰äºº
                broadcastMessage(msgPackage); 
            } else {
                // è®¿å®¢ï¼šåªå‘ç»™æˆ¿ä¸» (æˆ¿ä¸»ä¼šä»£ä¸ºè½¬å‘ç»™å…¶ä»–äºº)
                if (hostConnection && hostConnection.open) {
                    hostConnection.send(msgPackage);
                } else {
                    addSystemMsg("âŒ æœªè¿æ¥åˆ°æˆ¿ä¸»ï¼Œå‘é€å¤±è´¥");
                }
            }

            input.value = '';
        }

        // æˆ¿ä¸»å¹¿æ’­åŠŸèƒ½ (å°†æ¶ˆæ¯è½¬å‘ç»™é™¤ sourceConn ä»¥å¤–çš„æ‰€æœ‰äºº)
        function broadcastMessage(msgPackage, sourceConn = null) {
            connections.forEach(conn => {
                if (conn !== sourceConn && conn.open) {
                    conn.send(msgPackage);
                }
            });
        }

        // --- UI æ“ä½œ ---
        function enterChatScreen(roomName, roleName) {
            document.getElementById('login-screen').style.display = 'none';
            // æ˜¾å¼è®¾ç½®ä¸º flexï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ CSS é‡Œç”¨äº† display: flex
            document.getElementById('chat-screen').style.display = 'flex'; 
            
            document.getElementById('room-tag').innerText = roomName;
            const roleEl = document.getElementById('role-tag');
            roleEl.innerText = roleName;
            roleEl.className = myRole === 'host' ? 'role-host' : 'role-guest';
        }

        function addMessageBubble(text, isMe) {
            const box = document.getElementById('chat-box');
            const row = document.createElement('div');
            row.className = `message-row ${isMe ? 'me' : 'other'}`;
            row.innerHTML = `<div class="bubble">${escapeHtml(text)}</div>`;
            box.appendChild(row);
            box.scrollTop = box.scrollHeight;
        }

        function addSystemMsg(text) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = 'system-msg';
            div.innerText = text;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function showLog(text) {
            document.getElementById('status-log').innerText = text;
        }

        // é˜²æ­¢ XSS æ”»å‡»çš„ç®€å•è½¬ä¹‰
        function escapeHtml(text) {
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
