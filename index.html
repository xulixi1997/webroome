<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P æå…‰ç©ºé—´ | å®‰å…¨ä¼ è¾“</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --bg: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --danger: #ef4444;
            --success: #10b981;
        }

        * { box-sizing: border-box; outline: none; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            background-image: radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.1) 0%, transparent 20%),
                              radial-gradient(circle at 90% 80%, rgba(16, 185, 129, 0.05) 0%, transparent 20%);
            color: var(--text-main);
            margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center;
        }

        /* é€šç”¨ç»„ä»¶ */
        .btn {
            background: var(--primary); color: white; border: none; padding: 12px 20px;
            border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; width: 100%;
        }
        .btn:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn:disabled { background: #475569; cursor: not-allowed; transform: none; }
        
        input[type="text"] {
            width: 100%; background: #1e293b; border: 1px solid #334155; color: white;
            padding: 12px; border-radius: 8px; margin-bottom: 15px; transition: 0.2s;
        }
        input[type="text"]:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }

        /* å¡ç‰‡å®¹å™¨ */
        .card {
            background: var(--card-bg);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 40px; border-radius: 16px; width: 400px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            text-align: center;
            display: none; animation: fadeIn 0.4s ease;
        }
        .card.active { display: block; }

        h2 { margin: 0 0 10px 0; font-size: 24px; letter-spacing: -0.5px; }
        p { color: var(--text-sub); font-size: 14px; margin-bottom: 25px; line-height: 1.5; }

        /* å¯†ç å±•ç¤º */
        .code-box {
            background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px;
            font-family: monospace; font-size: 24px; color: var(--success); letter-spacing: 3px;
            margin: 20px 0; border: 1px dashed #475569; user-select: all; cursor: pointer;
        }
        .code-box:active { background: rgba(0,0,0,0.5); }

        /* èŠå¤©ä¸»ç•Œé¢ */
        #chat-container {
            width: 100%; max-width: 900px; height: 95vh; display: none; flex-direction: column;
            background: var(--card-bg); border-radius: 16px; overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
        }

        /* å¤´éƒ¨ */
        header {
            padding: 15px 20px; background: rgba(15, 23, 42, 0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex; justify-content: space-between; align-items: center;
        }
        .room-info span { font-size: 14px; color: var(--text-sub); margin-right: 15px; }
        .room-info strong { color: var(--text-main); }
        .status-badge { font-size: 12px; padding: 4px 8px; border-radius: 20px; background: #334155; }

        /* æ¶ˆæ¯åˆ—è¡¨ */
        #msg-list {
            flex: 1; overflow-y: auto; padding: 20px; scroll-behavior: smooth;
            /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
            scrollbar-width: thin; scrollbar-color: #475569 transparent;
        }
        #msg-list::-webkit-scrollbar { width: 6px; }
        #msg-list::-webkit-scrollbar-thumb { background-color: #475569; border-radius: 3px; }

        .msg-row { display: flex; margin-bottom: 20px; animation: slideUp 0.3s ease; }
        .msg-row.me { flex-direction: row-reverse; }
        
        .avatar {
            width: 36px; height: 36px; border-radius: 50%; background: #475569;
            display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;
            flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .msg-row.me .avatar { margin-left: 10px; background: var(--primary); }
        .msg-row.other .avatar { margin-right: 10px; }

        .bubble {
            max-width: 70%; padding: 12px 16px; border-radius: 12px; font-size: 15px; line-height: 1.5;
            position: relative; word-wrap: break-word; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .msg-row.me .bubble {
            background: var(--primary); color: white;
            border-top-right-radius: 2px;
        }
        .msg-row.other .bubble {
            background: #334155; color: #e2e8f0;
            border-top-left-radius: 2px;
        }

        /* åº•éƒ¨è¾“å…¥åŒº */
        footer {
            padding: 20px; background: rgba(15, 23, 42, 0.5);
            display: flex; gap: 10px; align-items: center;
        }
        .icon-btn {
            background: #334155; border: none; color: #cbd5e1; width: 44px; height: 44px;
            border-radius: 10px; cursor: pointer; transition: 0.2s; font-size: 18px; display: flex; align-items: center; justify-content: center;
        }
        .icon-btn:hover { background: #475569; color: white; }
        
        /* æ‹–æ‹½è¦†ç›–å±‚ */
        #drag-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.9); z-index: 100;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            border: 2px dashed var(--primary); pointer-events: none; /* è®©äº‹ä»¶ç©¿é€ï¼ŒJSæ§åˆ¶æ˜¾ç¤º */
        }
        #drag-overlay.active { display: flex; }
        .drag-text { font-size: 20px; font-weight: bold; color: var(--primary); margin-top: 20px; }

        /* Toast é€šçŸ¥ */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 999; }
        .toast {
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 30px;
            margin-bottom: 10px; font-size: 14px; animation: fadeIn 0.3s, fadeOut 0.3s 2.7s forwards;
            backdrop-filter: blur(4px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 8px;
        }

        /* æ–‡ä»¶è¿›åº¦æ¡ */
        .file-card { background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-top: 5px; min-width: 200px; }
        .progress-bar { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 8px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.2s; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(-10px); } }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="card-login" class="card active">
        <h2>ğŸš€ P2P æå…‰ç©ºé—´</h2>
        <p>ç«¯å¯¹ç«¯åŠ å¯† Â· é˜…åå³ç„š Â· 1GBå¤§æ–‡ä»¶</p>
        <input type="text" id="nick-in" placeholder="èµ·ä¸ªä»£å· (å¦‚: 007)" maxlength="8">
        <input type="text" id="room-in" placeholder="æˆ¿é—´å· (å¦‚: 888)">
        <button class="btn" onclick="startApp()">è¿›å…¥ / åˆ›å»ºæˆ¿é—´</button>
        <div id="login-msg" style="margin-top:15px; font-size:12px; color:var(--text-sub); min-height:18px;"></div>
    </div>

    <div id="card-host" class="card">
        <h2>ğŸ‘‘ æˆ¿é—´å·²åˆ›å»º</h2>
        <p>è¯·å°†æ­¤å¯†é’¥å‘é€ç»™å¥½å‹ (ç‚¹å‡»å¤åˆ¶)</p>
        <div class="code-box" onclick="copyToClipboard(this.innerText)">...</div>
        <p style="color: var(--danger); font-size: 12px;">âš ï¸ å¯†ç è¾“é”™ 10 æ¬¡å°†è‡ªåŠ¨é”€æ¯æˆ¿é—´</p>
        <button class="btn" onclick="enterChat('host')">è¿›å…¥èŠå¤©å®¤</button>
    </div>

    <div id="card-guest" class="card">
        <h2>ğŸ›¡ï¸ å®‰å…¨éªŒè¯</h2>
        <p>æ­¤æˆ¿é—´å—å¯†é’¥ä¿æŠ¤</p>
        <input type="text" id="auth-in" placeholder="è¾“å…¥ 8 ä½å¯†é’¥" style="text-align:center; letter-spacing:2px;">
        <button class="btn" onclick="submitAuth()">éªŒè¯èº«ä»½</button>
    </div>

    <div id="chat-container">
        <div id="drag-overlay">
            <div style="font-size: 50px;">ğŸ“‚</div>
            <div class="drag-text">æ¾å¼€æ‰‹æŒ‡ å‘é€æ–‡ä»¶</div>
        </div>

        <header>
            <div class="room-info">
                <span>æˆ¿é—´: <strong id="head-room">...</strong></span>
                <span class="status-badge" id="head-role">...</span>
            </div>
            <div class="room-info">
                <span><strong id="head-nick">...</strong></span>
            </div>
        </header>

        <div id="msg-list"></div>

        <footer>
            <button class="icon-btn" onclick="document.getElementById('file-in').click()" title="å‘é€æ–‡ä»¶">ğŸ“</button>
            <input type="file" id="file-in" style="display:none" onchange="processFile(this.files[0])">
            <input type="text" id="msg-in" placeholder="è¾“å…¥æ¶ˆæ¯..." style="margin:0;" onkeypress="if(event.key==='Enter') sendMsg()">
            <button class="btn" style="width: auto; padding: 0 25px;" onclick="sendMsg()">å‘é€</button>
        </footer>
    </div>

    <script>
        // --- å…¨å±€é…ç½® ---
        const CHUNK_SIZE = 16 * 1024; 
        const MAX_FILE_SIZE = 1024 * 1024 * 1024; // 1GB
        const MAX_ATTEMPTS = 10;

        // --- çŠ¶æ€å˜é‡ ---
        let peer, myRole, myNick, roomId, roomPwd;
        let failedAttempts = 0;
        let connMap = new Map(); // Hostç”¨
        let hostConn = null;     // Guestç”¨
        let incomingFiles = {};  // æ–‡ä»¶æ¥æ”¶ç¼“å†²

        // --- 1. å¯åŠ¨é€»è¾‘ ---
        function startApp() {
            const nick = document.getElementById('nick-in').value.trim();
            const room = document.getElementById('room-in').value.trim();
            
            if (!nick || !room) return showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
            
            myNick = nick;
            roomId = room;
            
            const btn = document.querySelector('#card-login .btn');
            btn.disabled = true; btn.innerText = "æ­£åœ¨æ¢æµ‹...";
            
            const fullId = 'secure-p2p-v6-' + room;
            const tempPeer = new Peer(fullId);

            tempPeer.on('open', (id) => {
                peer = tempPeer;
                initHost();
            });

            tempPeer.on('error', (err) => {
                if (err.type === 'unavailable-id') {
                    tempPeer.destroy();
                    initGuest(fullId);
                } else {
                    showToast('ç½‘ç»œé”™è¯¯: ' + err.type, 'error');
                    btn.disabled = false; btn.innerText = "è¿›å…¥ / åˆ›å»ºæˆ¿é—´";
                }
            });
        }

        // --- 2. æˆ¿ä¸»é€»è¾‘ ---
        function initHost() {
            myRole = 'host';
            roomPwd = generatePwd();
            document.querySelector('.code-box').innerText = roomPwd;
            showCard('card-host');
            
            peer.on('connection', conn => {
                conn.on('open', () => conn.send({ type: 'AUTH_REQ' }));
                
                conn.on('data', data => {
                    if (data.type === 'AUTH_SUBMIT') verifyGuest(conn, data);
                    else if (data.type === 'MSG' || data.type === 'FILE_META' || data.type === 'FILE_CHUNK') {
                        // ç®€å•çš„è·¯ç”±é€»è¾‘ï¼šå¦‚æœæ˜¯å·²éªŒè¯ç”¨æˆ·
                        // æ³¨æ„ï¼šå®é™…ç”Ÿäº§ä¸­éœ€è¦æ£€æŸ¥ verified çŠ¶æ€ï¼ŒDemo ç®€åŒ–å¤„ç†
                        handleData(data, conn);
                    }
                });

                conn.on('close', () => {
                    connMap.delete(conn.peer); // ç®€å•ç§»é™¤ï¼Œä¸å¹¿æ’­ç¦»å¼€ï¼Œé¿å…å¤ªåµ
                });
            });
        }

        function verifyGuest(conn, data) {
            if (data.payload === roomPwd) {
                connMap.set(conn.peer, conn);
                conn.send({ type: 'AUTH_OK', content: 'æ¬¢è¿åŠ å…¥å®‰å…¨é¢‘é“' });
                showToast(`${data.nick} å·²åŠ å…¥`, 'success');
            } else {
                failedAttempts++;
                conn.send({ type: 'AUTH_FAIL' });
                showToast(`âš ï¸ å¯†ç é”™è¯¯è­¦å‘Š (${failedAttempts}/${MAX_ATTEMPTS})`, 'error');
                if (failedAttempts >= MAX_ATTEMPTS) destroyRoom();
            }
        }

        function destroyRoom() {
            connMap.forEach(c => c.send({ type: 'DESTROY' }));
            setTimeout(() => { peer.destroy(); location.reload(); }, 1000);
        }

        // --- 3. è®¿å®¢é€»è¾‘ ---
        function initGuest(hostId) {
            myRole = 'guest';
            peer = new Peer();
            peer.on('open', () => {
                hostConn = peer.connect(hostId, { reliable: true });
                hostConn.on('open', () => document.getElementById('login-msg').innerText = "å·²è¿æ¥ï¼Œç­‰å¾…éªŒè¯...");
                
                hostConn.on('data', data => {
                    if (data.type === 'AUTH_REQ') showCard('card-guest');
                    else if (data.type === 'AUTH_OK') {
                        showToast(data.content, 'success');
                        enterChat('guest');
                    }
                    else if (data.type === 'AUTH_FAIL') showToast('å¯†ç é”™è¯¯', 'error');
                    else if (data.type === 'DESTROY') { alert('æˆ¿é—´å·²é”€æ¯'); location.reload(); }
                    else handleData(data);
                });
            });
        }

        function submitAuth() {
            const val = document.getElementById('auth-in').value.trim();
            if (!val) return;
            hostConn.send({ type: 'AUTH_SUBMIT', payload: val, nick: myNick });
        }

        // --- 4. èŠå¤©ä¸æ–‡ä»¶æ ¸å¿ƒ ---
        function enterChat(role) {
            document.querySelectorAll('.card').forEach(el => el.classList.remove('active'));
            document.getElementById('chat-container').style.display = 'flex';
            
            document.getElementById('head-room').innerText = roomId;
            document.getElementById('head-role').innerText = role === 'host' ? 'æˆ¿ä¸»' : 'è®¿å®¢';
            document.getElementById('head-nick').innerText = myNick;
            
            setupDragDrop();
        }

        function sendMsg() {
            const input = document.getElementById('msg-in');
            const txt = input.value.trim();
            if (!txt) return;
            
            const pkg = { type: 'MSG', content: txt, nick: myNick };
            renderMsg(pkg, true);
            sendData(pkg);
            input.value = '';
        }

        function handleData(data, senderConn) {
            if (data.type === 'MSG') renderMsg(data, false);
            else if (data.type === 'FILE_META') handleFileStart(data);
            else if (data.type === 'FILE_CHUNK') handleFileChunk(data);
            
            // æˆ¿ä¸»è½¬å‘é€»è¾‘
            if (myRole === 'host') {
                connMap.forEach(c => {
                    if (c !== senderConn && c.open) c.send(data);
                });
            }
        }

        function sendData(pkg) {
            if (myRole === 'host') connMap.forEach(c => c.open && c.send(pkg));
            else if (hostConn && hostConn.open) hostConn.send(pkg);
        }

        // --- æ–‡ä»¶åˆ†ç‰‡é€»è¾‘ (å¤ç”¨ V4 é€»è¾‘) ---
        function processFile(file) {
            if (!file) return;
            if (file.size > MAX_FILE_SIZE) return showToast('æ–‡ä»¶è¿‡å¤§ (ä¸Šé™1GB)', 'error');

            const fileId = Date.now().toString();
            const meta = { type: 'FILE_META', fileId, name: file.name, size: file.size, fileType: file.type, nick: myNick };
            
            renderFileProgress(fileId, file.name, true, null); // æ˜¾ç¤ºè¿›åº¦æ¡
            sendData(meta);

            // è¯»å–å¹¶å‘é€
            const reader = new FileReader();
            let offset = 0;
            
            reader.onload = (e) => {
                sendData({ type: 'FILE_CHUNK', fileId, chunk: e.target.result });
                offset += e.target.result.byteLength;
                updateProgress(fileId, offset, file.size);
                
                if (offset < file.size) readNext();
            };

            const readNext = () => reader.readAsArrayBuffer(file.slice(offset, offset + CHUNK_SIZE));
            readNext();
            document.getElementById('file-in').value = ''; // é‡ç½®
        }

        function handleFileStart(data) {
            incomingFiles[data.fileId] = { buffer: [], received: 0, total: data.size, meta: data };
            renderFileProgress(data.fileId, data.name, false, data.nick);
        }

        function handleFileChunk(data) {
            const ctx = incomingFiles[data.fileId];
            if (!ctx) return;
            
            ctx.buffer.push(data.chunk);
            ctx.received += data.chunk.byteLength;
            updateProgress(data.fileId, ctx.received, ctx.total);

            if (ctx.received >= ctx.total) {
                const blob = new Blob(ctx.buffer, { type: ctx.meta.fileType });
                finishFile(data.fileId, blob, ctx.meta.name);
                delete incomingFiles[data.fileId];
            }
        }

        // --- æ‹–æ‹½ä¸Šä¼ æ ¸å¿ƒé€»è¾‘ ---
        function setupDragDrop() {
            const container = document.getElementById('chat-container');
            const overlay = document.getElementById('drag-overlay');
            let dragCounter = 0;

            container.addEventListener('dragenter', e => {
                e.preventDefault();
                dragCounter++;
                overlay.classList.add('active');
            });

            container.addEventListener('dragleave', e => {
                e.preventDefault();
                dragCounter--;
                if (dragCounter === 0) overlay.classList.remove('active');
            });

            container.addEventListener('dragover', e => e.preventDefault());

            container.addEventListener('drop', e => {
                e.preventDefault();
                dragCounter = 0;
                overlay.classList.remove('active');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) processFile(files[0]);
            });
        }

        // --- UI æ¸²æŸ“è¾…åŠ© ---
        function renderMsg(data, isMe) {
            const list = document.getElementById('msg-list');
            const initial = isMe ? myNick[0] : data.nick[0];
            
            const div = document.createElement('div');
            div.className = `msg-row ${isMe ? 'me' : 'other'}`;
            div.innerHTML = `
                <div class="avatar">${initial.toUpperCase()}</div>
                <div class="bubble">
                    ${!isMe ? `<div style="font-size:12px;opacity:0.6;margin-bottom:4px">${data.nick}</div>` : ''}
                    ${escapeHtml(data.content)}
                </div>
            `;
            list.appendChild(div);
            scrollToBottom();
        }

        function renderFileProgress(id, name, isMe, nick) {
            const list = document.getElementById('msg-list');
            const initial = isMe ? myNick[0] : (nick ? nick[0] : '?');
            
            const div = document.createElement('div');
            div.className = `msg-row ${isMe ? 'me' : 'other'}`;
            div.innerHTML = `
                <div class="avatar">${initial.toUpperCase()}</div>
                <div class="bubble" id="bubble-${id}">
                    <div>${isMe ? 'ğŸ“¤ å‘é€' : 'ğŸ“¥ æ¥æ”¶'}: ${escapeHtml(name)}</div>
                    <div class="file-card">
                        <div style="font-size:12px; display:flex; justify-content:space-between">
                            <span id="txt-${id}">0%</span>
                        </div>
                        <div class="progress-bar"><div class="progress-fill" id="bar-${id}"></div></div>
                    </div>
                </div>
            `;
            list.appendChild(div);
            scrollToBottom();
        }

        function updateProgress(id, curr, total) {
            const pct = Math.floor((curr/total)*100) + '%';
            const bar = document.getElementById(`bar-${id}`);
            const txt = document.getElementById(`txt-${id}`);
            if (bar) bar.style.width = pct;
            if (txt) txt.innerText = pct;
        }

        function finishFile(id, blob, name) {
            const bubble = document.getElementById(`bubble-${id}`);
            if (!bubble) return;
            
            const url = URL.createObjectURL(blob);
            const isImg = blob.type.startsWith('image/');
            
            bubble.innerHTML = isImg 
                ? `<img src="${url}" style="max-width:200px;border-radius:8px;cursor:pointer" onclick="window.open('${url}')">`
                : `<div style="font-size:30px">ğŸ“„</div><a href="${url}" download="${name}" style="color:white">ä¸‹è½½: ${escapeHtml(name)}</a>`;
        }

        function showCard(id) {
            document.querySelectorAll('.card').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function showToast(msg, type = 'info') {
            const box = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = 'toast';
            el.style.borderLeft = `4px solid ${type === 'error' ? '#ef4444' : '#10b981'}`;
            el.innerHTML = `<span>${type==='error'?'âŒ':'âœ…'}</span> ${msg}`;
            box.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

        function scrollToBottom() {
            const list = document.getElementById('msg-list');
            list.scrollTop = list.scrollHeight;
        }

        function generatePwd() {
            const c = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789';
            return Array(8).fill(0).map(() => c[Math.floor(Math.random()*c.length)]).join('');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
            showToast('å¯†ç å·²å¤åˆ¶', 'success');
        }

        function escapeHtml(text) {
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }
    </script>
</body>
</html>
